var P=Object.defineProperty,R=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var D=(r,s,l)=>s in r?P(r,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):r[s]=l,p=(r,s)=>{for(var l in s||(s={}))S.call(s,l)&&D(r,l,s[l]);if(M)for(var l of M(s))k.call(s,l)&&D(r,l,s[l]);return r},x=(r,s)=>R(r,W(s));var h=(r,s,l)=>(D(r,typeof s!="symbol"?s+"":s,l),l);(function(r,s){typeof exports=="object"&&typeof module!="undefined"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(r=typeof globalThis!="undefined"?globalThis:r||self,s(r.CalendarGraph={}))})(this,function(r){"use strict";function s(a=new Date){let t=a.getFullYear();return t%4==0&&t%100!=0||t%400==0}function l(a=new Date){return new Date(a.getFullYear(),0,1)}function g(a=new Date){const t=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()),e=Date.UTC(a.getFullYear(),0,0);return(t-e)/1e3/60/60/24}function T(a){let t=[],e=7,i=b(a);for(;e;)t.push(g(z(i,e))),e--;return t}function z(a,t){return new Date(a.getFullYear(),a.getMonth(),a.getDay()-t)}function b(a){return new Date(new Date().getFullYear(),a+1,0)}class m{constructor(t,e){h(this,"width");h(this,"height");h(this,"gridData");this.offsetCellCount=t,this.options=e,this.init()}init(){let t=s()?366:365;this.gridData=new Array(t).fill(null).map((e,i)=>this.getCellPostionByDay(i+1)),this.setGridWidthHeight(t)}setGridWidthHeight(t){let{size:e,space:i}=this.options,o=Math.ceil((this.offsetCellCount+t)/7);this.width=o*e+(o+2)*i,this.height=7*e+8*i}getCellPostionByDay(t){let{size:e,space:i}=this.options,[o,n]=this.getCellRowColumnByDay(t),u=n*e+n*i+i,d=this.options.offsetY+o*e+o*i+i;return{x:u,y:d}}getCellRowColumnByDay(t){let{offsetCellCount:e}=this,i=Math.ceil((t+e)/7),o=7-(7*i-t-e);return i=i-1>0?i-1:0,o=o-1>0?o-1:0,[o,i]}static mergeData(t,e){const i=e.reduce((o,n)=>{let u=g(new Date(n.date))-1;return o[u]=n,o},{});for(let o=0;o<t.length;o++)t[o]=p(p({},t[o]),i[o]);return t}}class H{constructor(t,e){h(this,"monthBoundaryData");h(this,"_topBoundaryData",[]);h(this,"_bottomBoundaryData",[]);this._grid=t,this._opts=e;let i=this._getBoundarySideLines(),o=this._topBoundaryData.sort((u,d)=>u.x-d.x),n=this._bottomBoundaryData.sort((u,d)=>u.x-d.x);this.monthBoundaryData=[...i,o,n]}_getMonthBoundaryDays(){let t=[];t.push({type:"front",value:[1,2,3,4,5,6,7]});for(let e=0;e<12;e++)t.push({type:"end",value:T(e)});return t}_getBoundaryLine(t,e){let i=[],o=[],n=[];t.forEach(_=>{let{x:c,y:f}=this._grid.getCellPostionByDay(_);e=="end"&&(c=c+this._opts.size+this._opts.space),i.push(c),o.push(f),o.push(f+this._opts.size),n.push({x:c,y:f+this._opts.size}),n.push({x:c,y:f})});let u=Math.min(...i),d=Math.max(...i),C=Math.min(...o),B=Math.max(...o),w=[];if(d!=u){n=n.sort((y,F)=>y.y-F.y);let _=-1;for(let y=0;y<n.length;y++)if(n[y+1].y-n[y].y==this._opts.space&&n[y+1].x!=n[y].x){_=y;break}let c=x(p({},n[_]),{y:n[_].y+this._opts.space/2}),f=x(p({},n[_+1]),{y:n[_+1].y-this._opts.space/2});w=c.x<f.x?[c,f]:[f,c]}return this._bottomBoundaryData.push({x:u,y:B}),this._topBoundaryData.push({x:d,y:C}),[{x:u,y:B},...w,{x:d,y:C}]}_getBoundarySideLines(){return this._getMonthBoundaryDays().map(e=>this._getBoundaryLine(e.value,e.type))}}class v{constructor(t){h(this,"monthTitleData");this.init(t)}init(t){this.monthTitleData=new Array(12).fill(null).map((e,i)=>{let o=this.getMonthColumn(i,t.offsetCellCount);return{title:i+1+"\u6708",x:o*t.size+o*t.space,y:t.titleHeight/2}})}getMonthColumn(t,e){let i=new Date(new Date().getFullYear(),t,1+e),o=g(i),n=i.getDay(),u=Math.ceil(o/7)-1;return n==1?u:u+1}}class G{constructor(t,e){h(this,"_context");h(this,"_ratio");this._options=e,this._context=t.getContext("2d"),this._ratio=this.initRatio(e.devicePixelRatio,this._context),t.width=e.calendarWidth*this._ratio,t.height=e.calendarHeight*this._ratio,this.render()}initRatio(t,e){t=t||window.devicePixelRatio||1;let i=e.webkitBackingStorePixelRatio||1;return t/i}render(t){this._context.clearRect(0,0,this._options.calendarWidth*this._ratio,this._options.calendarHeight*this._ratio);let{monthTitleData:e,gridData:i,monthBoundaryData:o}=this._options;t&&t.length>0&&(i=m.mergeData(i,t)),this.renderMonthTitle(e),this.renderGrid(i),this.renderMonthBoundary(o),this._context.scale(this._ratio,this._ratio)}renderMonthTitle(t){this._context.fillStyle=this._options.fontColor,this._context.font=this._options.font,this._context.textBaseline="middle",t.forEach(e=>{this._context.fillText(e.title,e.x,e.y)})}renderMonthBoundary(t){this._context.strokeStyle=this._options.borderColor,this._context.beginPath(),t.forEach(e=>{this._context.moveTo(e[0].x,e[0].y),e.forEach(i=>{this._context.lineTo(i.x,i.y)})}),this._context.stroke(),this._context.closePath()}renderGrid(t){t.forEach(e=>{this._context.fillStyle=this._options.colorFunc(e.count||0),this._context.fillRect(e.x,e.y,this._options.size,this._options.size)})}}class Y{constructor(t){h(this,"canvasWidth");h(this,"canvasHeight");h(this,"_monthTitle");h(this,"_grid");h(this,"_canvasGraph");h(this,"_monthBoundary");this._options=t,this.init(t)}setCanvas(t){this._canvasGraph=new G(t,{devicePixelRatio:this._options.devicePixelRatio,calendarWidth:this.canvasWidth,calendarHeight:this.canvasHeight,gridData:this._grid.gridData,monthTitleData:this._monthTitle.monthTitleData,monthBoundaryData:this._monthBoundary.monthBoundaryData,size:this._options.size,font:this._options.font,colorFunc:this._options.colorFunc,fontColor:this._options.fontColor,borderColor:this._options.borderColor})}init(t){let e=this.getOffsetCellCount();this._monthTitle=new v({offsetCellCount:e,size:t.size,space:t.space,titleHeight:t.titleHeight}),this._grid=new m(e,{offsetY:t.titleHeight,size:t.size,space:t.space}),this.canvasWidth=this._grid.width,this.canvasHeight=this._grid.height+t.titleHeight,this._monthBoundary=new H(this._grid,{size:this._options.size,space:this._options.space})}getOffsetCellCount(){let t=0,e=l().getDay();return e==0?t=6:t=e-1,t}render(t){this._canvasGraph.render(t)}}r.CalendarGraph=Y,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
