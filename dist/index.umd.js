var Y=Object.defineProperty,v=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var m=(h,n,d)=>n in h?Y(h,n,{enumerable:!0,configurable:!0,writable:!0,value:d}):h[n]=d,f=(h,n)=>{for(var d in n||(n={}))P.call(n,d)&&m(h,d,n[d]);if(M)for(var d of M(n))k.call(n,d)&&m(h,d,n[d]);return h},B=(h,n)=>v(h,L(n));var a=(h,n,d)=>(m(h,typeof n!="symbol"?n+"":n,d),d);(function(h,n){typeof exports=="object"&&typeof module!="undefined"?n(exports):typeof define=="function"&&define.amd?define(["exports"],n):(h=typeof globalThis!="undefined"?globalThis:h||self,n(h.CalendarGraph={}))})(this,function(h){"use strict";function n(r=new Date){let t=r.getFullYear();return t%4==0&&t%100!=0||t%400==0}function d(r=new Date){return new Date(r.getFullYear(),0,1)}function g(r=new Date){const t=Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()),e=Date.UTC(r.getFullYear(),0,0);return(t-e)/1e3/60/60/24}function T(r){let t=[],e=7,i=z(r);for(;e;)t.push(g(i)-e+1),e--;return t}function z(r){return new Date(new Date().getFullYear(),r+1,0)}class C{constructor(t,e){a(this,"width");a(this,"height");a(this,"gridData");this.offsetCellCount=t,this.options=e,this.init()}init(){let t=n()?366:365;this.gridData=new Array(t).fill(null).map((e,i)=>this.getCellPostionByDay(i+1)),this.setGridWidthHeight(t)}setGridWidthHeight(t){let{size:e,space:i}=this.options,s=Math.ceil((this.offsetCellCount+t)/7);this.width=s*e+(s+2)*i,this.height=7*e+8*i}getCellPostionByDay(t){let{size:e,space:i}=this.options,[s,o]=this.getCellRowColumnByDay(t),l=o*e+o*i+i,c=this.options.offsetY+s*e+s*i+i;return{x:l,y:c}}getCellRowColumnByDay(t){let{offsetCellCount:e}=this,i=Math.ceil((t+e)/7),s=7-(7*i-t-e);return i=i-1>0?i-1:0,s=s-1>0?s-1:0,[s,i]}static mergeData(t,e){const i=e.reduce((s,o)=>{let l=g(new Date(o.date))-1;return s[l]=o,s},{});for(let s=0;s<t.length;s++)t[s]=f(f({},t[s]),i[s]);return t}}class b{constructor(t,e){a(this,"monthBoundaryData");a(this,"_topBoundaryData",[]);a(this,"_bottomBoundaryData",[]);this._grid=t,this._opts=e;let i=this._getBoundarySideLines(),s=this._topBoundaryData.sort((l,c)=>l.x-c.x),o=this._bottomBoundaryData.sort((l,c)=>l.x-c.x);this.monthBoundaryData=[...i,s,o]}_getMonthBoundaryDays(){let t=[];t.push({type:"front",value:[1,2,3,4,5,6,7]});for(let e=0;e<12;e++)t.push({type:"end",value:T(e)});return t}_getBoundaryLine(t,e){let i=[],s=[],o=[];t.forEach(p=>{let{x:u,y:_}=this._grid.getCellPostionByDay(p);e=="end"?u=u+this._opts.size+this._opts.space/2:u=u-this._opts.space/2,i.push(u),s.push(_),s.push(_+this._opts.size),o.push({x:u,y:_+this._opts.size}),o.push({x:u,y:_})});let l=Math.min(...i),c=Math.max(...i),x=Math.min(...s),D=Math.max(...s),w=[];if(c!=l){o=o.sort((y,W)=>y.y-W.y);let p=-1;for(let y=0;y<o.length;y++)if(o[y+1].y-o[y].y==this._opts.space&&o[y+1].x!=o[y].x){p=y;break}let u=B(f({},o[p]),{y:o[p].y+this._opts.space/2}),_=B(f({},o[p+1]),{y:o[p+1].y-this._opts.space/2});w=u.x<_.x?[u,_]:[_,u]}return this._bottomBoundaryData.push({x:l,y:D+this._opts.space/2}),this._topBoundaryData.push({x:c,y:x-this._opts.space/2}),[{x:l,y:D},...w,{x:c,y:x}]}_getBoundarySideLines(){return this._getMonthBoundaryDays().map(e=>this._getBoundaryLine(e.value,e.type))}}class H{constructor(t){a(this,"monthTitleData");this.init(t)}init(t){this.monthTitleData=new Array(12).fill(null).map((e,i)=>{let s=this.getMonthColumn(i,t.offsetCellCount);return{title:i+1+"\u6708",x:s*t.size+s*t.space+t.space/2,y:t.titleHeight/2}})}getMonthColumn(t,e){let i=new Date(new Date().getFullYear(),t,1),s=g(i),o=i.getDay(),l=Math.ceil((s+e)/7)-1;return o==1?l:l+1}}class S{constructor(t,e){a(this,"_context");a(this,"_ratio");a(this,"_isScaled",!1);this._options=e,this._context=t.getContext("2d"),this._ratio=this.initRatio(e.devicePixelRatio,this._context),t.width=e.calendarWidth*this._ratio,t.height=e.calendarHeight*this._ratio,this.render()}initRatio(t,e){t=t||window.devicePixelRatio||1;let i=e.webkitBackingStorePixelRatio||1;return t/i}render(t){this._context.clearRect(0,0,this._options.calendarWidth*this._ratio,this._options.calendarHeight*this._ratio);let{monthTitleData:e,gridData:i,monthBoundaryData:s,todayBoundaryData:o}=this._options;t&&t.length>0&&(i=C.mergeData(i,t)),this._isScaled||(this._context.scale(this._ratio,this._ratio),this._isScaled=!0),this.renderMonthTitle(e),this.renderGrid(i),this.renderMonthBoundary(s),this.renderTodayBoundary(o)}renderMonthTitle(t){this._context.fillStyle=this._options.fontColor,this._context.font=this._options.font,this._context.textBaseline="middle",this._context.textAlign="left",t.forEach(e=>{this._context.fillText(e.title,e.x,e.y)})}renderTodayBoundary(t){this._context.setLineDash([]),this._context.strokeStyle=this._options.borderColor,this._context.lineWidth=this._options.space/2,this._context.beginPath(),t.forEach(e=>{this._context.lineTo(e.x,e.y)}),this._context.closePath(),this._context.stroke()}renderMonthBoundary(t){this._context.strokeStyle=this._options.borderColor,this._context.lineWidth=this._options.space/2,this._context.beginPath(),this._context.setLineDash([this._options.space*2,this._options.space]),t.forEach(e=>{this._context.moveTo(e[0].x,e[0].y),e.forEach(i=>{this._context.lineTo(i.x,i.y)})}),this._context.stroke()}renderGrid(t){t.forEach(e=>{this._context.fillStyle=this._options.colorFunc(e.count||0),this._context.fillRect(e.x,e.y,this._options.size,this._options.size)})}}class G{constructor(t,e){a(this,"todayBoundaryData");let i=g(new Date),{x:s,y:o}=t.getCellPostionByDay(i),l={x:s-e.space/2,y:o-e.space/2},c={x:s+e.size+e.space/2,y:o-e.space/2},x={x:s-e.space/2,y:o+e.size+e.space/2},D={x:s+e.size+e.space/2,y:o+e.size+e.space/2};this.todayBoundaryData=[l,c,D,x]}}class R{constructor(t){a(this,"canvasWidth");a(this,"canvasHeight");a(this,"_monthTitle");a(this,"_grid");a(this,"_canvasGraph");a(this,"_monthBoundary");a(this,"_todayBoundary");this._options=t,this.init(t)}setCanvas(t){this._canvasGraph=new S(t,{devicePixelRatio:this._options.devicePixelRatio,calendarWidth:this.canvasWidth,calendarHeight:this.canvasHeight,gridData:this._grid.gridData,monthTitleData:this._monthTitle.monthTitleData,monthBoundaryData:this._monthBoundary.monthBoundaryData,todayBoundaryData:this._todayBoundary.todayBoundaryData,size:this._options.size,space:this._options.space,font:this._options.font,colorFunc:this._options.colorFunc,fontColor:this._options.fontColor,borderColor:this._options.borderColor})}init(t){let e=this.getOffsetCellCount();this._monthTitle=new H({offsetCellCount:e,size:t.size,space:t.space,titleHeight:t.titleHeight}),this._grid=new C(e,{offsetY:t.titleHeight,size:t.size,space:t.space}),this.canvasWidth=this._grid.width,this.canvasHeight=this._grid.height+t.titleHeight,this._monthBoundary=new b(this._grid,{size:this._options.size,space:this._options.space}),this._todayBoundary=new G(this._grid,{size:this._options.size,space:this._options.space})}getOffsetCellCount(){let t=0,e=d().getDay();return e==0?t=6:t=e-1,t}render(t){this._canvasGraph.render(t)}}h.CalendarGraph=R,Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
