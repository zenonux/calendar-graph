(function(l,r){typeof exports=="object"&&typeof module!="undefined"?r(exports):typeof define=="function"&&define.amd?define(["exports"],r):(l=typeof globalThis!="undefined"?globalThis:l||self,r(l.CalendarGraph={}))})(this,function(l){"use strict";var S=Object.defineProperty;var G=(l,r,_)=>r in l?S(l,r,{enumerable:!0,configurable:!0,writable:!0,value:_}):l[r]=_;var n=(l,r,_)=>(G(l,typeof r!="symbol"?r+"":r,_),_);function r(a=new Date){let t=a.getFullYear();return t%4==0&&t%100!=0||t%400==0}function _(a=new Date){return new Date(a.getFullYear(),0,1)}function f(a=new Date){const t=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()),e=Date.UTC(a.getFullYear(),0,0);return(t-e)/1e3/60/60/24}function B(a){let t=[],e=7,i=C(a);for(;e;)t.push(f(i)-e+1),e--;return t}function C(a){return new Date(new Date().getFullYear(),a+1,0)}class D{constructor(t,e){n(this,"width");n(this,"height");n(this,"gridData");this.offsetCellCount=t,this.options=e,this.init()}init(){let t=r()?366:365;this.gridData=new Array(t).fill(null).map((e,i)=>this.getCellPostionByDay(i+1)),this.setGridWidthHeight(t)}setGridWidthHeight(t){let{size:e,space:i}=this.options,o=Math.ceil((this.offsetCellCount+t)/7);this.width=o*e+(o+2)*i,this.height=7*e+8*i}getCellPostionByDay(t){let{size:e,space:i}=this.options,[o,s]=this.getCellRowColumnByDay(t),h=s*e+s*i+i,d=this.options.offsetY+o*e+o*i+i;return{x:h,y:d}}getCellRowColumnByDay(t){let{offsetCellCount:e}=this,i=Math.ceil((t+e)/7),o=7-(7*i-t-e);return i=i-1>0?i-1:0,o=o-1>0?o-1:0,[o,i]}static mergeData(t,e){const i=e.reduce((o,s)=>{let h=f(new Date(s.date))-1;return o[h]=s,o},{});for(let o=0;o<t.length;o++)t[o]={...t[o],...i[o]};return t}}class M{constructor(t,e){n(this,"monthBoundaryData");n(this,"_topBoundaryData",[]);n(this,"_bottomBoundaryData",[]);this._grid=t,this._opts=e;let i=this._getBoundarySideLines(),o=this._topBoundaryData.sort((h,d)=>h.x-d.x),s=this._bottomBoundaryData.sort((h,d)=>h.x-d.x);this.monthBoundaryData=[...i,o,s]}_getMonthBoundaryDays(){let t=[];t.push({type:"front",value:[1,2,3,4,5,6,7]});for(let e=0;e<12;e++)t.push({type:"end",value:B(e)});return t}_getBoundaryLine(t,e){let i=[],o=[],s=[];t.forEach(p=>{let{x:c,y}=this._grid.getCellPostionByDay(p);e=="end"?c=c+this._opts.size+this._opts.space/2:c=c-this._opts.space/2,i.push(c),o.push(y),o.push(y+this._opts.size),s.push({x:c,y:y+this._opts.size}),s.push({x:c,y})});let h=Math.min(...i),d=Math.max(...i),g=Math.min(...o),x=Math.max(...o),m=[];if(d!=h){s=s.sort((u,H)=>u.y-H.y);let p=-1;for(let u=0;u<s.length;u++)if(s[u+1].y-s[u].y==this._opts.space&&s[u+1].x!=s[u].x){p=u;break}let c={...s[p],y:s[p].y+this._opts.space/2},y={...s[p+1],y:s[p+1].y-this._opts.space/2};m=c.x<y.x?[c,y]:[y,c]}return this._bottomBoundaryData.push({x:h,y:x+this._opts.space/2}),this._topBoundaryData.push({x:d,y:g-this._opts.space/2}),[{x:h,y:x},...m,{x:d,y:g}]}_getBoundarySideLines(){return this._getMonthBoundaryDays().map(e=>this._getBoundaryLine(e.value,e.type))}}class w{constructor(t){n(this,"monthTitleData");this.options=t,this._init()}_init(){this.monthTitleData=new Array(12).fill(null).map((t,e)=>this.getMonthTitleInfo(e))}getMonthTitleInfo(t){let{options:e}=this,i=this._getMonthColumn(t,e.offsetCellCount);return{title:t+1+"\u6708",month:t,x:i*e.size+i*e.space+e.space/2,y:e.titleHeight/2}}_getMonthColumn(t,e){let i=new Date(new Date().getFullYear(),t,1),o=f(i),s=i.getDay(),h=Math.ceil((o+e)/7)-1;return s==1?h:h+1}}class T{constructor(t,e){n(this,"_context");n(this,"_ratio");n(this,"_isScaled",!1);this._options=e,this._context=t.getContext("2d"),this._ratio=this.initRatio(e.devicePixelRatio,this._context),t.width=e.calendarWidth*this._ratio,t.height=e.calendarHeight*this._ratio,this.render()}initRatio(t,e){t=t||window.devicePixelRatio||1;let i=e.webkitBackingStorePixelRatio||1;return t/i}render(t){this._context.clearRect(0,0,this._options.calendarWidth*this._ratio,this._options.calendarHeight*this._ratio);let{monthTitleData:e,gridData:i,monthBoundaryData:o,todayBoundaryData:s}=this._options;t&&t.length>0&&(i=D.mergeData(i,t)),this._isScaled||(this._context.scale(this._ratio,this._ratio),this._isScaled=!0),this.renderMonthTitle(e),this.renderGrid(i),this.renderMonthBoundary(o),this.renderTodayBoundary(s)}renderMonthTitle(t){this._context.fillStyle=this._options.fontColor,this._context.font=this._options.font,this._context.textBaseline="middle",this._context.textAlign="left",t.forEach(e=>{this._context.fillText(e.title,e.x,e.y)})}renderTodayBoundary(t){this._context.setLineDash([]),this._context.strokeStyle=this._options.borderColor,this._context.lineWidth=this._options.space/2,this._context.beginPath(),t.forEach(e=>{this._context.lineTo(e.x,e.y)}),this._context.closePath(),this._context.stroke()}renderMonthBoundary(t){this._context.strokeStyle=this._options.borderColor,this._context.lineWidth=this._options.space/2,this._context.beginPath(),this._context.setLineDash([this._options.space*2,this._options.space]),t.forEach(e=>{this._context.moveTo(e[0].x,e[0].y),e.forEach(i=>{this._context.lineTo(i.x,i.y)})}),this._context.stroke()}renderGrid(t){t.forEach(e=>{this._context.fillStyle=this._options.colorFunc(e.count||0),this._context.fillRect(e.x,e.y,this._options.size,this._options.size)})}}class z{constructor(t,e){n(this,"todayBoundaryData");let i=f(new Date),{x:o,y:s}=t.getCellPostionByDay(i),h={x:o-e.space/2,y:s-e.space/2},d={x:o+e.size+e.space/2,y:s-e.space/2},g={x:o-e.space/2,y:s+e.size+e.space/2},x={x:o+e.size+e.space/2,y:s+e.size+e.space/2};this.todayBoundaryData=[h,d,x,g]}}class b{constructor(t){n(this,"canvasWidth");n(this,"canvasHeight");n(this,"_monthTitle");n(this,"_grid");n(this,"_canvasGraph");n(this,"_monthBoundary");n(this,"_todayBoundary");this._options=t,this._init(t)}_init(t){let e=this.getOffsetCellCount();this._monthTitle=new w({offsetCellCount:e,size:t.size,space:t.space,titleHeight:t.titleHeight}),this._grid=new D(e,{offsetY:t.titleHeight,size:t.size,space:t.space}),this.canvasWidth=this._grid.width,this.canvasHeight=this._grid.height+t.titleHeight,this._monthBoundary=new M(this._grid,{size:this._options.size,space:this._options.space}),this._todayBoundary=new z(this._grid,{size:this._options.size,space:this._options.space})}setCanvas(t){this._canvasGraph=new T(t,{devicePixelRatio:this._options.devicePixelRatio,calendarWidth:this.canvasWidth,calendarHeight:this.canvasHeight,gridData:this._grid.gridData,monthTitleData:this._monthTitle.monthTitleData,monthBoundaryData:this._monthBoundary.monthBoundaryData,todayBoundaryData:this._todayBoundary.todayBoundaryData,size:this._options.size,space:this._options.space,font:this._options.font,colorFunc:this._options.colorFunc,fontColor:this._options.fontColor,borderColor:this._options.borderColor})}getMonthTitleInfo(t){return this._monthTitle.getMonthTitleInfo(t)}getOffsetCellCount(){let t=0,e=_().getDay();return e==0?t=6:t=e-1,t}render(t){this._canvasGraph.render(t)}}l.CalendarGraph=b,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
